name: Node.js CI/CD Workflow

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to EC2
      env:
        PORT: ${{ vars.PORT }}
        MONGO_URI: ${{ secrets.MONGO_URI }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        NODE_ENV: ${{ vars.NODE_ENV }}
        APP_URL: ${{ vars.APP_URL }}
        OTA_SERVER_URL: ${{ vars.OTA_SERVER_URL }}
        AWS_MQTT_ENDPOINT: ${{ secrets.AWS_MQTT_ENDPOINT }}
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: ${{ secrets.AWS_REGION }}
        AUDIO_BUCKET: ${{ vars.AUDIO_BUCKET }}
        IMAGE_BUCKET: ${{ vars.IMAGE_BUCKET }}
        OTA_BUCKET: ${{ vars.OTA_BUCKET }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        UNWIREDLABS_API_KEY: ${{ secrets.UNWIREDLABS_API_KEY }}
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
      run: |
        # Debug: Show environment variables
        echo "Deploying with environment variables..."
        
        # SSH into EC2 and run deployment script
        ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} 'bash -s' << 'ENDSSH'
          # Ensure verbose output and stop on error
          set -ex

          # Verify Node.js and npm are available
          echo "Node.js version: $(node -v)"
          echo "npm version: $(npm -v)"

          # Navigate to app directory
          cd ~/app

          # Ensure node_modules is clean
          rm -rf node_modules

          # Install dependencies
          export PATH=/usr/local/bin:$PATH
          which npm
          which node
          npm ci

          # Create .env file with values
          cat > .env << EOF
          MONGO_URI=$MONGO_URI
          JWT_SECRET=$JWT_SECRET
          NODE_ENV=$NODE_ENV
          APP_URL=$APP_URL
          OTA_SERVER_URL=$OTA_SERVER_URL
          AWS_MQTT_ENDPOINT=$AWS_MQTT_ENDPOINT
          AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
          AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
          AWS_REGION=$AWS_REGION
          AUDIO_BUCKET=$AUDIO_BUCKET
          IMAGE_BUCKET=$IMAGE_BUCKET
          OTA_BUCKET=$OTA_BUCKET
          GOOGLE_API_KEY=$GOOGLE_API_KEY
          UNWIREDLABS_API_KEY=$UNWIREDLABS_API_KEY
          EMAIL_USER=$EMAIL_USER
          EMAIL_PASS=$EMAIL_PASS
          EOF
          PORT=$PORT

          # Ensure PM2 is installed
          npm install -g pm2 || true

          # Restart or start application with PM2
          pm2 restart app || pm2 start src/server.js --name "app"

          # Show running processes
          pm2 list
        ENDSSH

    - name: Deployment Status
      if: success()
      run: echo "ðŸš€ Deployment completed successfully"

    - name: Deployment Failure
      if: failure()
      run: echo "âŒ Deployment failed. Check logs."